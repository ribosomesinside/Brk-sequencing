---
title: "ubi-Brk_3h"
author: "Masha"
date: "2024-04-15"
output:
  pdf_document: default
  html_document:
    keep_md: true
---

```{r setup-chunk, include=FALSE}
knitr::opts_chunk$set(dev = "png",
                      dpi = 300,
                      echo = TRUE,
                      cache = TRUE)
```

## Introduction

This is RNAseq analysis using deseq2. Two conditions: "control" and "ubi-brk", 3 repeats for each condition.

Experimental setup:

**SalE/PV-ShineGal4\>Brk(x)** â€“ dark control or "control" in this analysis;

**ubi-ShineGal4\>Brk(x)** - 3h light induction of UAS-Brk overexpression, called "ubi-brk" here;

SalE/PV-ShineGal4\>Brk(x) - 3h ight induction of UAS-Brk overexpression in Sal compartment - not included in this analysis due to low number of def expressed genes.

All conditions were processed at the same time with several rounds of sample collection (different days, several crosses). For each repeat 50 discs were combined in one tube (could use up to 35 next time).

## Preparing the data
### Loading libraries

```{r loading libraries, echo=TRUE, message = FALSE, warning=FALSE}
library(DESeq2)
library(apeglm)
library(dplyr)
library(tibble)
library(tidyverse)
library(data.table)
library(ggplot2)
library(ggfortify)
library(ggrepel)
library(RColorBrewer)
library(pheatmap)
library(plotly)
library(magrittr)
library(AnnotationDbi)
library(org.Dm.eg.db)
library(writexl)
```

### Load data
```{r}
counts <- fread(file ="rsem.merged.gene_counts.tsv", header=TRUE)
sample_info <- read.delim(file = "Data info/RN23010-sampleinfo_full.txt")

```

### Prepare a matrix for DESeq:

Make first column row names, switch to integers, create a matrix object

```{r}
info<-sample_info %>% column_to_rownames("Sample")
info %>%  filter(Group !='sal-brk') ->ninfo

gcounts <- counts[, -c(2,6:8)]

dt <- as.data.frame(gcounts) %>%
  column_to_rownames("gene_id") 

dt[,1:6] <- lapply(dt[,1:6], as.integer)

mcountdata <- as.matrix(dt) 

has_rownames(dt)
has_rownames(ninfo)
```

### Matching column order between the tables

```{r}
all(rownames(ninfo) == colnames(mcountdata))
mcountdata_s <- mcountdata[, rownames(ninfo)]
all(rownames(ninfo) == colnames(mcountdata_s))
```

### Creating levels for samples.

It will read the first level to be compared with the rest.

```{r}
ninfo$Group <- factor(ninfo$Group,levels = c("control", "ubi-brk"))
info$Repeat <- as.factor(info$Repeat)
```

## Run deseq.

The object class used by the DESeq2 package to store the read counts and the intermediate estimated quantities during statistical analysis is the **DESeqDataSet**, which will usually be represented in the code here as an object **dds**.

```{r deseq, message=FALSE}
dds <- DESeqDataSetFromMatrix(countData = mcountdata_s,
                              colData = ninfo,
                              design = ~Group)
dds <- DESeq(dds)
res <- results(dds)
sum(res$padj < 0.01 & res$log2FoldChange< (-0.3), na.rm=TRUE)
resultsNames(dds)
```

### Data shrinkage to remove low count data

```{r}
ubiLFC <- lfcShrink(dds, coef="Group_ubi.brk_vs_control", type="apeglm")

plotMA(res, ylim=c(-4,4))
plotMA(ubiLFC, ylim=c(-4,4))
```
### Converting ubiLFC to a table format with gene names added
```{r}
ubiLFC %>% 
  as.data.frame() %>% 
  mutate(., gene = mapIds(
  org.Dm.eg.db,
  keys = rownames(.),
  column ="SYMBOL",
  keytype = "FLYBASE",
  multiVals = "first"
)) %>% 
  rownames_to_column(.) %>% 
    mutate(gene = coalesce(gene,rowname)) %>% 
  rename(., ID=rowname) -> ubiLFC_genes

```

### Filtering significantly diff expressed genes 
Padj<001, basemean>100, and arranging according to log2 fold change

```{r ubi-brk-signif}
ubiLFC_genes %>% 
  filter((padj<0.01) & (baseMean>100)) %>% 
  arrange(log2FoldChange) -> ubiLFC_s
#write_xlsx(ubiLFC_s, "ubi-brk-signif.xlsx")
```

### Removing transposon genes
They are present due to differences in cell lines, as I didnt see them in Sal comparison
```{r p-el remove}
ubiLFC_s %>% 
  filter(!stringr::str_detect(ID, "FBti")) ->ubiLFC_s_pel.rm
```

Looking at voclano plot

```{r}
ggplot(ubiLFC_s_pel.rm, aes(log2FoldChange, -log10(padj))) +
  geom_point() +
  xlab("log2 fold change") + 
        ylab("-log10 adjusted p-value") +
  theme(legend.position = "none", 
              plot.title = element_text(size = rel(1.5), hjust = 0.5), 
              axis.title = element_text(size = rel(1.25))) +
  theme_bw() +
  geom_label_repel(data=head(ubiLFC_s_pel.rm, 20), aes(label=gene), max.overlaps=30)
```
## Gene set enrichment analysis
```{r installing-loading packages, echo = FALSE, message = FALSE}
#BiocManager::install("clusterProfiler")
#BiocManager::install("pathview")
#BiocManager::install("enrichplot")
library(clusterProfiler)
library(enrichplot)
```

```{r}
# we want the log2 fold change 
original_gene_list <- ubiLFC_s_pel.rm$log2FoldChange

# name the vector
names(original_gene_list) <- ubiLFC_s_pel.rm$gene

# omit any NA values 
gene_list<-na.omit(original_gene_list)

# sort the list in decreasing order (required for clusterProfiler)
gene_list = sort(gene_list, decreasing = TRUE)

```

```{r}
gse<- gseGO (gene_list,
             OrgDb=org.Dm.eg.db,
             ont="BP",
             keyType="SYMBOL",
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             minGSSize=3,
             pAdjustMethod = "BH")
summary(gse) %>% as.tibble() -> gse_sum
gseaplot(gse, by = "all", title = gse$Description[1], geneSetID = 1)
```
slim1-more general, slim2 more specific
```{r}
summary(gse) %>% as.tibble() -> gse_sum
gse_sum %>% filter(p.adjust<0.05)
```
### Correct way to do GSEA is to use it on the whole dataset, and then rank according FC*pvalue
```{r}
ubiLFC_genes %>% 
  mutate(rank_stats=log2FoldChange*-log10(padj)) %>% 
  arrange(desc(rank_stats)) %>% 
  filter(!stringr::str_detect(ID, "FBti") & (baseMean>100)) %>% 
  na.omit() %>% 
  select(gene, rank_stats) %>% 
  mutate(rank_stats=ifelse(is.infinite(rank_stats), 1000, rank_stats)) %>% 
  deframe()-> ubiLFC_rank
```

```{r}
gse_cor <- gseGO(ubiLFC_rank,
                 ont="BP",
                 OrgDb=org.Dm.eg.db,
                 keyType="SYMBOL",
                 pvalueCutoff = 0.5, 
                 verbose = TRUE, 
                 minGSSize=3,
                 pAdjustMethod = "BH")
summary(gse_cor) %>% as.tibble() -> gse_cor.sum
gseaplot(gse_cor, by = "all", title = gse_cor$Description[1], geneSetID = 1)
```

```{r}
intersect(names(ubiLFC_rank), names(gene_list))
```

### Another way to make a ranked list is to take LFC values and sort them only according to FC. Which result willI get then?

```{r}
ubiLFC_genes %>% 
  arrange(desc(log2FoldChange)) %>% 
  filter(!stringr::str_detect(ID, "FBti")) %>% 
  na.omit() %>% 
  select(gene, log2FoldChange) %>% 
  deframe()-> ubiLFC_fc_rank
```

```{r}
gse_fc<- gseGO (ubiLFC_fc_rank,
             ont="BP",
             OrgDb=org.Dm.eg.db,
             keyType="SYMBOL",
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             minGSSize=3,
             pAdjustMethod = "BH")
summary(gse_fc) %>% as.tibble() -> gse_fc_sum
gseaplot(gse_fc, by = "all", title = gse_fc$Description[1], geneSetID = 1)
```
```{r}
#gse_fc_s<-lapply(gse_fc@result$NES, sort, decreasing = TRUE)
#dotplot(gse_fc_s, showCategory=10)
```

```{r}
top20<-dotplot(gse_fc, showCategory=10)
up_down<-dotplot(gse_fc, showCategory=10, split=".sign", orderBy="Counts") + facet_grid(.~.sign)
up_down
#cowplot::plot_grid(top20, up_down, ncol=1, labels=LETTERS[1:2])
```
```{r}
# 1. Open jpeg file
jpeg("gsea.jpg", width = 500, height = 700)
# 2. Create the plot
up_down
# 3. Close the file
dev.off()
```

```{r}

ribo<-gseaplot2(gse_fc, geneSetID = "GO:0042254", title = gse_fc$Description[1])
resp<-gseaplot2(gse_fc, geneSetID = "GO:0022904", title = gse_fc$Description[13])
repl<-gseaplot2(gse_fc, geneSetID = "GO:0006260", title = gse_fc$Description[8])
ribo_plot <- cowplot::as_ggplot(ribo)
resp_plot <- as_ggplot(resp)
repl_plot <- as_ggplot(repl)
cowplot::plot_grid(ribo_plot, resp_plot, repl_plot, labels=LETTERS[1:3])
```

### Yet another way is to use Wald statistics, that incorporates the relationship between pvalue and FC

```{r}
wald_stat <- dds@rowRanges@elementMetadata@listData$WaldStatistic_Group_ubi.brk_vs_control
dds_res <- res %>% data.frame()
dds_res %>% 
  mutate(., gene = mapIds(
  org.Dm.eg.db,
  keys = rownames(.),
  column ="SYMBOL",
  keytype = "FLYBASE",
  multiVals = "first"
)) %>% 
  rownames_to_column(.) %>% 
    mutate(gene = coalesce(gene,rowname)) %>% 
  rename(., ID=rowname) -> dds_res_genes
```

```{r}
dds_res_genes %>% 
  arrange(desc(stat)) %>% 
  filter(!stringr::str_detect(ID, "FBti")) %>% 
  na.omit() %>% 
  select(gene, stat) %>% 
  deframe()-> dds_wald_rank
```

```{r}
gse_wald<- gseGO (dds_wald_rank,
             ont="BP",
             OrgDb=org.Dm.eg.db,
             keyType="SYMBOL",
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             minGSSize=3,
             pAdjustMethod = "BH")
summary(gse_wald) %>% as.tibble() -> gse_wald_sum
gseaplot(gse_wald, by = "all", title = gse_wald$Description[1], geneSetID = 1)
```
```{r}
dotplot(gse_wald, showCategory=5, split=".sign") + facet_grid(.~.sign)
```
```{r}
dotplot(gse_wald, showCategory=20)
```

```{r}
wald<-heatplot(gse_wald, showCategory="rRNA metabolic process", foldChange=ubiLFC_fc_rank)
fc<-heatplot(gse_fc, showCategory="rRNA metabolic process", foldChange=ubiLFC_fc_rank)
cowplot::plot_grid(wald, fc, ncol=1, labels=LETTERS[1:2])
```
```{r}
gseaplot2(gse_wald, geneSetID = 1, title = gse_wald$Description[1])
```

```{r}
library(ggupset)
upsetplot(gse_wald, n=5)
```

